# Deadlock (데드락)

데드락 = 여러 프로세스가 서로가 가진 자원을 기다리며 영원히 진행되지 못하는 상태.

핵심 조건은 “순환 대기(circular wait)”이며, 모든 프로세스가 서로를 기다려 어느 누구도 앞으로 실행될 수 없다.

## 데드락이 발생하려면 반드시 필요한 4가지 조건

**① 상호 배제(Mutual Exclusion)**
- 자원은 동시에 여러 프로세스가 공유할 수 없다 → 즉 “독점 자원”.
- 예: 프린터, 파일 lock, 세마포어 1개짜리

**② 점유 대기(Hold and Wait)**
- 프로세스가 일부 자원을 가진 상태에서 추가 자원을 요청하며 기다림.

**③ 비선점(No Preemption)**
- OS가 강제로 자원을 빼앗을 수 없다.
- 자원은 오직 그걸 가진 프로세스가 스스로 반납해야 한다.

**④ 순환 대기(Circular Wait)**
- 프로세스들이 원을 이루며 서로의 자원을 기다리는 구조가 되어야 한다.

- 예:
P1이 R1 보유 → R2 기다림
P2가 R2 보유 → R3 기다림
P3가 R3 보유 → R1 기다림
→ 원(circle) 발생 → 모두 교착

## 데드락이 실제로 왜 문제가 되는가

(step-by-step 내부 동작 분석)

1. OS는 lock 요청을 처리하려고 한다.
2. 하지만 어떤 프로세스가 lock A를 가진 채 lock B를 요청한다.
3. 동시에 다른 프로세스가 lock B를 가진 채 lock A를 요청한다.
4. 둘 다 상대방이 가진 lock이 반납되기만을 기다린다.
5. 그러나 상대방도 새로운 lock을 못 얻어 진행이 불가능 → 둘 다 멈춤.
6. OS는 강제로 lock을 뺏을 권한이 없으면(deadlock 조건 ③) 해결 못 함.
7. 그래서 데드락은 “정지된 상태 그대로 영원히 기다리게 되는 비정상 상태”가 된다.

## 데드락 해결 전략

### ① 데드락 예방(Prevention)

아예 Coffman 조건 중 하나를 강제로 깨버리는 방식이다.

예:
- 상호 배제 제거? → 불가능한 자원 많음
- 점유·대기 제거? → 자원을 요청하기 전에 모두 미리 획득하게 강제
- 비선점 제거? → 필요하면 OS가 자원을 강제로 빼앗음

- 순환 대기 제거? → “자원 순서를 강제”해서 cycle이 생기지 않도록 함
  - 예: 모든 lock에 번호를 붙이고 항상 번호가 큰 lock부터 요청하게 규칙화

단점: 시스템 효율이 떨어짐.

### 데드락 회피(Avoidance)

데드락이 “발생하기 전에” 시스템 상태가 안전한지 검사하며 자원 할당을 결정한다.

대표 알고리즘 → **Banker’s Algorithm(은행가 알고리즘)**[^1]

- 프로세스가 미래에 필요한 최대 자원량을 미리 선언해야 한다.
- 요청을 들어줬을 때 “안전 상태”가 유지되는지 체크 후 허용.

단점:
- 프로세스가 미래 자원 요구량을 정확히 알아야 함 → 현실에서 어려움.

[^1]: 어떤 자원의 할당을 허용하는지에 관한 여부를 결정하기 전, 미리 결정된 모든 자원들의 최대 가능한 할당량을 가지고 시물레이션 해서 Safe State에 들 수 있는지 여부를 검사한다.
그러나, 은행원 알고리즘은 이처럼 미리 최대 자원 요구량을 알아야 하고, 할당할 수 있는 자원 수가 일정해야 하는 등 사용에 있어 제약조건이 많다는 단점도 존재한다.


### 데드락 탐지(Detection) + 회복(Recovery)

#### 탐지

- 주기적으로 자원 할당 그래프(Resource Allocation Graph)를 검사해 **cycle(순환)** 이 생겼는지 확인.

#### 회복 방식 3가지

1. 교착된 프로세스 중 하나를 강제 종료
2. 자원을 빼앗아 회복 (state rollback 필요)
3. checkpoint 지점으로 되돌리고 다시 실행

단점: 복구 비용이 큼.

### 데드락 무시(Ignore) → 실제 운영체제 대부분이 이 방식

일명 “鸚鵡 정책(오류를 무시하는 정책)” — 은근히 현실적.

리눅스, 윈도우, macOS 대부분은 “데드락 자동 해결” 기능이 없다.
그냥 개발자가 알아서 해결하도록 맡긴다.

이유:
- OS 레벨에서 탐지·회피·예방을 모두 하면 오버헤드가 너무 크다.
- 데드락은 대부분 어플리케이션 레벨에서 lock 설계가 잘못돼서 발생한다.

# 세마포어 (Semaphore)

세마포어는 운영체제에서 공유 자원의 접근을 제어하기 위한 동기화 도구입니다. 여러 프로세스나 스레드가 동시에 자원에 접근하려 할 때 충돌을 방지하고, 임계 영역(Critical Section) 문제를 해결하는 데 사용됩니다.

## 세마포어의 기본 개념

세마포어는 내부적으로 정수 값을 가지고 있으며, 두 가지 기본 연산을 지원합니다:

## 상호 배제 (Mutual Exclusion)

**뮤텍스(Mutual Exclusion)** 는 **임계 영역(Critical Section)** 을 하나의 스레드만 접근하도록 보장하는 락(Lock)입니다.
-> 하나의 프로세스가 공유 자원을 사용할 때 다른 프로세스의 접근을 막는 것이다.

- 상호 배제 알고리즘
  - 데커 알고리즘
  - 피커슨 알고리즘
  - 제과점 알고리즘

- 상호 배제는 교착상태의 4가지 필요조건 중 하나
  - 상호 배제 : 배타적 통제권(동시 사용 불가)
  - 점유 대기 : 할당된 자원을 가진 상태에서 다른 자원을 기다림
  - 비선점 : 다른 프로세스가 선점하고 있는 자원을 뺏을 수 없음
  - 순환대기 : 각 프로세스는 순환적으로 다음 프로세스가 요구하는 자원을 가지고 있는 상황

- 교착 상태와 기아 상태
  - 교착 상태 (DeadLock) : 무한 대기
  - 기아 상태 (Starvation) : 우선 순위가 낮아 자원을 계속 할당받지 못하는 상태

-  멀티 프로세스나 멀티 스레드 동기화에 사용된다
- 동기화 (Synchronize) : 상호 배제를 위해 프로세스/스레드들의 실행을 제어하는 것. 
-> 여기에 세마포어, 뮤텍스, 모니터 개념이 적용된다

### 임계구역 (Critical Section) 이란?

어떤 한 프로세스가 이 구역을 사용중일 때 다른 프로세스가 같은 구역을 사용(접근)하려 한다면 문제가 발생할 수 있다
따라서 문제가 발생하지 않도록 한번에 하나의 프로세스만 이용하게끔 보장해야 하는 영역이다.

임계 구역 문제 해결을 위한 3가지 조건

1. 상호배제
   - 하나의 프로세스가 임계 구역에 들어가있다면 다른 프로세스는 들어갈 수 없어야 함
2. 진행
   - 임계 영역에 들어간 프로세스가 없는 상태에서 들어가려 하는 프로세스가 여러개라면 어느 것이 들어갈 지 결정해주어야 함
3. 한정 
   - 대기다른 프로세스의 기아(Starvation)을 방지하기 위해, 한 번 임계 구역에 들어간 프로세스는 다음번 임계 구역에 들어가려고 할 때 제한을 두어야 함

임계 구역의 동시 접근을 해결하기 위한 방법
- 세마포어(Semaphore)
- 락(Lock)
- 모니터(Monitor)

## 세마포어 접근 함수 - wait(), signal()

1. **P 연산 (또는 wait/down)**

- 사용 가능한 공유 자원이 없다면 기다림
- 사용 가능한 공유 자원이 있다면 세마포어 변수를 -1 처리한 후 사용

1. **V 연산 (또는 signal/up)**

- 공유 자원을 모두 사용한 후에 세마포어 변수를 +1 처리함
- 공유 자원 사용을 완료했다는 신호를 보냄
- 블록되어 있던 다른 프로세스가 있다면, 그 중 하나를 깨웁니다.

## 세마포어의 두 가지 종류

### 계수형 세마포어 (counting semaphore)

0과 1의 값을 가지는 이진형 세마포어(binary semaphore)와 달리, 풀에 있는 자원의 수와 같은 값으로 초기화 되는 동기화 기법

- 동작 메커니즘
  1. 세마포어는 Pool 자원 수와 같은 값으로 초기화
  2. P 호출이 발생할 때 마다 세마포어 1씩 감소, Pool 자원이 추가 할당되어 스레드에서 사용 표시
  3. V 호출은 세마포어 1씩 증가시켜 스레드가 자원을 Pool로 반납, 자원을 다른 스레드에 할당 가능 표시
  4. 세마포어가 0까지 줄어들었을 때 스레드가 P 호출 시 스레드는 V 통해 자원을 Pool로 반납 시까지 대기

### 바이너리 세마포어 (Binary Semaphore)

이진 세마포어의 값은 0과 1사이의 값만 가능하며 뮤텍스 락과 유사하게 동작함

- 동작 메커니즘
  1. 상호 배제를 위해 신호 전달 메커니즘을 사용해서 잠금을 구현
  2. 세마포어가 0이면 잠겨있고 1이면 잠금이 해제되어있는 것을 의미

